<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>MeowMap ‚Äî –∫–∞—Ä—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- MapLibre CSS -->
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>

  <style>
    html, body { height: 100%; margin: 0; }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    #controls{
      display:flex;align-items:center;gap:8px;
      padding:12px;background:#f7f7f7;border-bottom:1px solid #ccc;
    }
    input[type=date]{font-size:16px;}
    #logo{height:32px;}
    #burger{cursor:pointer;font-size:26px;display:none;}
    #closeSidebar{cursor:pointer;font-size:22px;font-weight:bold;}

    #layout{
      display:flex;
      height: 100dvh;         /* —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      max-height: 100vh;      /* –∑–∞–ø–∞—Å –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–æ–≤ */
      overflow: hidden;
    }
    #map{
      flex:1;
      min-height: 320px;      /* –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–∏–Ω–∏–º—É–º */
    }
    #sidebar{
      width:300px;background:#fff;overflow-y:auto;
      padding:12px;font-size:14px;border-left:1px solid #ccc;
    }
    #sidebar .item{
      margin-bottom:12px;cursor:pointer;
      border-bottom:1px dashed #ccc;padding-bottom:8px;
    }
    #sidebar .item:hover{background:#f0f0f0;}

    @media (max-width: 768px){
      #layout{flex-direction:column;}
      #sidebar{
        position:fixed;right:0;top:0;height:100dvh;
        transform:translateX(100%);
        transition:transform .3s;
        z-index:999;box-shadow:-4px 0 6px rgba(0,0,0,.15);
      }
      #sidebar.open{transform:translateX(0);}
      #burger{display:block;margin-left:auto;}
    }
  </style>
</head>
<body>

  <div id="controls">
    <label for="event-date">üìÖ</label>
    <input type="date" id="event-date">
    <img id="logo"
         src="https://sun9-81.userapi.com/impf/rcuLPGnzIPly7IQhX6MbA5TICbdWnl6AhMVSXQ/dFRCwb6vi5k.jpg?size=1818x606&quality=95&crop=0,21,1541,513&sign=34cbe06fb366638d9c7ca0693f1f83ef&type=cover_group"
         alt="Meow Records">
    <span id="burger">‚ò∞</span>
  </div>

  <div id="layout">
    <div id="map"></div>

    <div id="sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;">–ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
        <span id="closeSidebar">‚úï</span>
      </div>
      <hr>
      <div id="upcoming">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>
  </div>

  <!-- MapLibre JS -->
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
    const JSON_URL     = 'events.json?v=' + Date.now(); // –∞–Ω—Ç–∏-–∫—ç—à
    const MAPTILER_KEY = '9BgGWvEZYMAkWdKLxOui';        // –ø—Ä–∏ 401/403 –±—É–¥–µ—Ç —Ñ–æ–ª–±—ç–∫

    // Fallback: –ø—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—Ç—Ä OSM
    const OSM_RASTER_STYLE = {
      "version": 8,
      "sources": {
        "osm": {
          "type": "raster",
          "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          "tileSize": 256,
          "attribution": "¬© OpenStreetMap"
        }
      },
      "layers": [{ "id": "osm", "type": "raster", "source": "osm" }]
    };

    function createMap(useFallback=false){
      return new maplibregl.Map({
        container:'map',
        style: useFallback
          ? OSM_RASTER_STYLE
          : `https://api.maptiler.com/maps/basic/style.json?key=${MAPTILER_KEY}`,
        center:[20.45,54.71],
        zoom:10
      });
    }

    let map = createMap(false);

    function attachControls(){
      map.addControl(new maplibregl.NavigationControl(),'top-right');
      map.addControl(new maplibregl.GeolocateControl({
        positionOptions:{enableHighAccuracy:true},
        showUserLocation:true
      }),'top-right');
    }
    function wireResize(){
      map.on('load', () => { map.resize(); setTimeout(()=>map.resize(), 150); });
      window.addEventListener('resize', () => map.resize());
    }

    map.on('error', (e) => {
      const msg = String(e && e.error && e.error.message || '');
      if (msg.includes('Unauthorized') || msg.includes('Forbidden') || msg.includes('Failed to load')) {
        try { map.remove(); } catch(_) {}
        map = createMap(true);
        attachControls();
        wireResize();
        loadEventsAndRender();
      }
    });

    attachControls();
    wireResize();

    // –ú–∞—Ä–∫–µ—Ä—ã
    let markers=[];
    function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
    function addMarker(ev){
      const pop=new maplibregl.Popup({offset:25})
        .setHTML(`<b>${ev.title}</b><br>${ev.location}<br>${ev.date}`);
      const m=new maplibregl.Marker().setLngLat([ev.lon,ev.lat]).setPopup(pop).addTo(map);
      markers.push(m);
    }
    function flyToEvent(e){
      map.flyTo({center:[e.lon,e.lat],zoom:14});
      const m = markers.find(mk => {
        const p = mk.getLngLat();
        return Math.abs(p.lat - e.lat) < 1e-5 && Math.abs(p.lng - e.lon) < 1e-5;
      });
      if (m) m.togglePopup();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadEvents(){
      try{
        const r = await fetch(JSON_URL, {cache:'no-store'});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      }catch(err){
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å events.json:', err);
        return [];
      }
    }

    function renderForDate(events, dateStr){
      clearMarkers();
      const todays = events.filter(e => e.date === dateStr);
      todays.forEach(addMarker);
      if (todays.length) map.flyTo({center:[todays[0].lon, todays[0].lat], zoom:12});
    }

    async function loadEventsAndRender(){
      const events = await loadEvents();
      const upDiv = document.getElementById('upcoming');

      if(!events.length){
        upDiv.textContent = '–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ JSON –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è';
        return;
      }

      events.sort((a,b)=>a.date.localeCompare(b.date));

      const input = document.getElementById('event-date');
      input.min = events[0].date; input.max = events.at(-1).date;
      const today = new Date().toISOString().slice(0,10);
      const first = events.find(e=>e.date>=today)?.date || events[0].date;
      input.value = first;

      upDiv.innerHTML = '';
      const upcoming = events
        .filter(e=>new Date(e.date)>=new Date(today))
        .slice(0,100);

      if(!upcoming.length){ upDiv.textContent='–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'; }
      else upcoming.forEach(e=>{
        const d=document.createElement('div');
        d.className='item';
        d.innerHTML=`<strong>${e.title}</strong><br>${e.location}<br><i>${e.date}</i>`;
        d.onclick=()=>{
          renderForDate(events, e.date);
          setTimeout(()=>{ flyToEvent(e); }, 80);
          document.getElementById('sidebar').classList.remove('open');
          setTimeout(()=>map.resize(), 120);
        };
        upDiv.appendChild(d);
      });

      renderForDate(events, first);
      input.onchange = ev=>{
        const d=new Date(ev.target.value).toISOString().slice(0,10);
        renderForDate(events, d);
        setTimeout(()=>map.resize(), 60);
      };
    }

    // –°–∞–π–¥–±–∞—Ä
    document.getElementById('burger').onclick=()=>{
      const sb = document.getElementById('sidebar');
      sb.classList.toggle('open');
      setTimeout(()=>map.resize(), 120);
    };
    document.getElementById('closeSidebar').onclick=()=>{
      document.getElementById('sidebar').classList.remove('open');
      setTimeout(()=>map.resize(), 120);
    };

    // –°—Ç–∞—Ä—Ç
    loadEventsAndRender();
  </script>
</body>
</html>
