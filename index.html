<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>MeowMap ‚Äî –∫–∞—Ä—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>
  <style>
    body{margin:0;font-family:sans-serif;}
    #controls{
      display:flex;align-items:center;gap:8px;
      padding:12px;background:#f7f7f7;border-bottom:1px solid #ccc;
    }
    input[type=date]{font-size:16px;}
    #logo{height:32px;}
    #burger{cursor:pointer;font-size:26px;}
    #count{margin-left:8px;font-weight:bold;}
    #map{flex:1;}
    #sidebar{
      width:300px;background:#fff;overflow-y:auto;
      padding:12px;font-size:14px;border-left:1px solid #ccc;
    }
    #sidebar div.item{
      margin-bottom:12px;cursor:pointer;
      border-bottom:1px dashed #ccc;padding-bottom:8px;
    }
    #sidebar div.item:hover{background:#f0f0f0;}
    #closeSidebar{cursor:pointer;font-size:22px;font-weight:bold;}
    #burger{display:none;}
    @media(max-width:768px){
      #layout{flex-direction:column;}
      #sidebar{
        position:fixed;right:0;top:0;height:100%;
        transform:translateX(100%);
        transition:transform .3s;
        z-index:999;box-shadow:-4px 0 6px rgba(0,0,0,.15);
      }
      #sidebar.open{transform:translateX(0);}
      #burger{display:block;margin-left:auto;}
      #count{display:none;}
    }
  </style>
</head>
<body>

  <div id="controls">
    <label for="event-date">üìÖ</label>
    <input type="date" id="event-date">
    <img id="logo"
         src="https://sun9-81.userapi.com/impf/rcuLPGnzIPly7IQhX6MbA5TICbdWnl6AhMVSXQ/dFRCwb6vi5k.jpg?size=1818x606&quality=95&crop=0,21,1541,513&sign=34cbe06fb366638d9c7ca0693f1f83ef&type=cover_group"
         alt="Meow Records">
    <span id="burger">‚ò∞</span>
    <!-- <span id="count"></span> -->
  </div>

  <div id="layout" style="display:flex;height:90vh;">
    <div id="map"></div>

    <div id="sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;">–ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
        <span id="closeSidebar">‚úï</span>
      </div>
      <hr>
      <div id="upcoming"></div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    const JSON_URL     = 'events.json?v=20250730';
    const MAPTILER_KEY = 'QAuK0LSzMpyDV8I7iX6a';

    const map = new maplibregl.Map({
      container:'map',
      style:`https://api.maptiler.com/maps/basic/style.json?key=${MAPTILER_KEY}`,
      center:[20.45,54.71],
      zoom:10
    });

    map.addControl(new maplibregl.NavigationControl(),'top-right');
    map.addControl(new maplibregl.GeolocateControl({
      positionOptions:{enableHighAccuracy:true},
      showUserLocation:true
    }),'top-right');

    // –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç—ã
    map.on('load', () => {
      setTimeout(() => map.resize(), 100);
    });

    let markers=[];

    function clearMarkers(){markers.forEach(m=>m.remove());markers=[];}
    function addMarker(ev){
      const pop=new maplibregl.Popup({offset:25})
        .setHTML(`<b>${ev.title}</b><br>${ev.location}<br>${ev.date}`);
      const m=new maplibregl.Marker().setLngLat([ev.lon,ev.lat]).setPopup(pop).addTo(map);
      markers.push(m);
    }

    fetch(JSON_URL).then(r=>r.json()).then(events=>{
      events.sort((a,b)=>a.date.localeCompare(b.date));
      const input=document.getElementById('event-date');
      input.min=events[0].date;input.max=events.at(-1).date;
      const today=new Date().toISOString().slice(0,10);
      const first=events.find(e=>e.date>=today)?today:events[0].date;
      input.value=first;

      function render(dateStr){
        clearMarkers();
        const todays=events.filter(e=>e.date===dateStr);
        todays.forEach(addMarker);
        // document.getElementById('count').textContent=todays.length;
        if(todays.length) map.flyTo({center:[todays[0].lon,todays[0].lat],zoom:12});
      }

      const upcoming=events.filter(e=>new Date(e.date)>=new Date(today)).slice(0,100);
      const upDiv=document.getElementById('upcoming');
      if(!upcoming.length){upDiv.textContent='–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';}
      else upcoming.forEach(e=>{
        const d=document.createElement('div');
        d.className='item';
        d.innerHTML=`<strong>${e.title}</strong><br>${e.location}<br><i>${e.date}</i>`;
        d.onclick=()=>{
          render(e.date);
          setTimeout(()=>{
            const m = markers.find(mk => {
              const p = mk.getLngLat();
              return Math.abs(p.lat - e.lat) < 1e-5 && Math.abs(p.lng - e.lon) < 1e-5;
            });
            if (m) {
              map.flyTo({center:[e.lon,e.lat],zoom:14});
              m.togglePopup();
            }
            document.getElementById('sidebar').classList.remove('open');
          },100);
        };
        upDiv.appendChild(d);
      });

      render(first);
      input.onchange=ev=>{
        const d=new Date(ev.target.value).toISOString().slice(0,10);
        render(d);
      };
    });

    document.getElementById('burger').onclick=()=>document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('closeSidebar').onclick=()=>document.getElementById('sidebar').classList.remove('open');
  </script>
</body>
</html>